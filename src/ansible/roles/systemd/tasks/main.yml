---
#---------------------------------------------------------------
# deinstall classic networking
#---------------------------------------------------------------
# pi@raspberrypi:~ $ sudo -Es   # if not already done
# root@raspberrypi:~ # systemctl daemon-reload
# root@raspberrypi:~ # systemctl disable --now ifupdown dhcpcd dhcpcd5 isc-dhcp-client isc-dhcp-common rsyslog
# root@raspberrypi:~ # apt --autoremove purge ifupdown dhcpcd dhcpcd5 isc-dhcp-client isc-dhcp-common rsyslog
# root@raspberrypi:~ # rm -r /etc/network /etc/dhcp

- name: Remove packages
  apt:
    name: "{{ hhwm_packages_remove }}"
    state: absent
    purge: yes
  notify:
    - reboot

- name: Install packages
  apt:
    name: "{{ hhwm_packages_install }}"
    state: present
  notify:
    - reboot

#---------------------------------------------------------------
# Remove old configuration files
#---------------------------------------------------------------
- name: Remove /etc/dhcp
  file:
    path: /etc/dhcp
    state: absent

- name: Remove /etc/network
  file:
    path: /etc/network
    state: absent

- name: Remove /etc/wpa_supplicant/wpa_supplicant.conf
  file:
    path: /etc/wpa_supplicant/wpa_supplicant.conf
    state: absent

#---------------------------------------------------------------
# Setup new configuration files
#---------------------------------------------------------------
- name: Link /etc/resolv.conf
  file:
    state: link
    src: /run/systemd/resolve/stub-resolv.conf 
    dest: /etc/resolv.conf
    force: yes

- name: Create /etc/systemd/network/10-enX.network
  copy:
    src: 10-enX.network
    dest: /etc/systemd/network/10-enX.network
    owner: root
    group: root
    mode: '0644'
  notify:
    - reboot

- name: Create /etc/systemd/network/10-wlX.network
  copy:
    src: 10-wlX.network
    dest: /etc/systemd/network/10-wlX.network
    owner: root
    group: root
    mode: '0644'
  when: hhwm_wlan0_enabled == "yes"
  notify:
    - reboot

- name: Remove /etc/systemd/network/10-wlX.network
  file:
    path: /etc/systemd/network/10-wlX.network
    state: absent
  when: hhwm_wlan0_enabled != "yes"
  notify:
    - reboot

# rm -f /etc/systemd/network/73-usb-net-by-mac.link
- name: Remove /etc/systemd/network/73-usb-net-by-mac.link
  file:
    path: /etc/systemd/network/73-usb-net-by-mac.link
    state: absent
  notify:
    - reboot

# rm -f /etc/systemd/network/99-default.link
- name: Remove /etc/systemd/network/99-default.link
  file:
    path: /etc/systemd/network/99-default.link
    state: absent
  notify:
    - reboot

- name: Create /etc/wpa_supplicant/wpa_supplicant-wlan0.conf
  template:
    src: wpa_supplicant-wlan0.conf.j2
    dest: /etc/wpa_supplicant/wpa_supplicant-wlan0.conf
    owner: root
    group: root
    mode: '0600'
  when: hhwm_wlan0_enabled == "yes"
  notify:
    - reboot

- name: Remove /etc/wpa_supplicant/wpa_supplicant-wlan0.conf
  file:
    path: /etc/wpa_supplicant/wpa_supplicant-wlan0.conf
    state: absent
  when: hhwm_wlan0_enabled != "yes"
  notify:
    - reboot

- name: Disable wpa_supplicant.service
  systemd:
    name: wpa_supplicant
    enabled: no
    masked: yes
    state: stopped
  notify:
    - reboot

- name: Enable/Disable wpa_supplicant@wlan0.service
  systemd:
    name: wpa_supplicant@wlan0
    enabled: "{{ hhwm_wlan0_enabled }}"
  notify:
    - reboot

- name: Enable systemd-networkd.service
  systemd:
    name: systemd-networkd.service
    enabled: yes
  notify:
    - reboot

- name: Enable systemd-resolved.service
  systemd:
    name: systemd-resolved.service
    enabled: yes
  notify:
    - reboot

- name: Enable systemd-timesyncd.service
  systemd:
    name: systemd-timesyncd.service
    enabled: yes
  notify:
    - reboot
